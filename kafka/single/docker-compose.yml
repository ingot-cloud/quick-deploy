version: "3.8"

services:
  ##############################################################
  # Kafka Broker - 单机企业级配置
  ##############################################################
  kafka:
    image: docker-registry.ingotcloud.top/apache/kafka:3.8.0
    container_name: ${BROKER1_NAME}
    restart: always

    # 端口映射
    ports:
      - "${BROKER1_PORT}:9092"        # EXTERNAL：外部客户端访问 Kafka
      - "${BROKER1_CONTROLLER_PORT}:9093"        # CONTROLLER：KRaft 控制器端口
      # 29092:29092 不需要映射，INTERNAL listener 容器内部访问使用

    environment:
      ##########################################################
      # =============== 1. 基础 KRaft 配置（官方格式） ==========
      ##########################################################
      KAFKA_PROCESS_ROLES: "broker,controller"   # KRaft 节点角色
      KAFKA_NODE_ID: ${BROKER1_ID}               # 唯一 Node ID
      KAFKA_CONTROLLER_QUORUM_VOTERS: ${CLUSTER_CONTROLLER_SERVERS}  # 单节点集群投票节点
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER # Controller listener 名称, 指定供外部使用的控制类请求信息
      KAFKA_CLUSTER_ID: "${CLUSTER_ID}"            # 固定 UUID，不可变
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: false      # 禁止 topic 自动创建
      # 单机 KRaft 必须加的内部 topic 副本配置
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      ##########################################################
      # =============== 2. Listener / 网络配置 ==================
      ##########################################################
      # 定义 listener name 与协议
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: >
        INTERNAL:PLAINTEXT,
        EXTERNAL:PLAINTEXT,
        CONTROLLER:PLAINTEXT
      # 容器内部 listener (供 AKHQ & 内部客户端访问)
      # 宿主机 listener 只暴露 EXTERNAL
      KAFKA_LISTENERS: >
        INTERNAL://:29092,
        EXTERNAL://:9092,
        CONTROLLER://:9093
      # Advertised listener: 内部用 INTERNAL, 外部用 EXTERNAL
      KAFKA_ADVERTISED_LISTENERS: >
        INTERNAL://kafka:29092,
        EXTERNAL://${BROKER1_HOST}:${BROKER1_PORT}
      # Broker 自己之间（即 KRaft）内部通信，强制使用内部 listener
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

      ##########################################################
      # =============== 3. 日志与存储优化 =======================
      ##########################################################
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"

      KAFKA_LOG_SEGMENT_BYTES: 1073741824        # 1GB segment
      KAFKA_LOG_RETENTION_HOURS: 72               # 保留 3 天
      KAFKA_LOG_RETENTION_BYTES: 150000000000     # 最大 150GB
      KAFKA_LOG_CLEANER_ENABLE: "true"            # 支持 compact topic

      ##########################################################
      # =============== 4. 性能优化（适配 8 核 CPU） ============
      ##########################################################
      KAFKA_NUM_NETWORK_THREADS: 8               # 网络线程数
      KAFKA_NUM_IO_THREADS: 16                   # I/O 线程数
      KAFKA_SOCKET_SEND_BUFFER_BYTES: 102400     # socket 发送缓冲 100KB
      KAFKA_SOCKET_RECEIVE_BUFFER_BYTES: 102400  # socket 接收缓冲 100KB
      KAFKA_SOCKET_REQUEST_MAX_BYTES: 104857600  # 100MB 请求上限

      ##########################################################
      # =============== 5. JVM 优化 =================
      ##########################################################
      KAFKA_HEAP_OPTS: "${BROKER_HEAP_OPTS}"            # 可根据吞吐调整
      KAFKA_JVM_PERFORMANCE_OPTS: >
        -server
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=20

    volumes:
      - ${BROKER1_VOLUME}:/var/lib/kafka/data
    env_file:
      - ./.env

  ##############################################################
  # AKHQ - Kafka 可视化管理界面
  ##############################################################
  akhq:
    image: docker-registry.ingotcloud.top/tchiotludo/akhq:0.26.0
    container_name: akhq
    restart: always
    ports:
      - "${AKHQ_PORT}:8080"  # AKHQ web 界面端口
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            local:
              properties:
                bootstrap.servers: "kafka:29092"  # 内部容器使用 INTERNAL listener 访问 Kafka
    depends_on:
      - kafka
    env_file:
      - ./.env